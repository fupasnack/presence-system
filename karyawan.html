<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Presensi FUPA — Karyawan</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFC107" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#FFF59D; --bg2:#FFD54F; --bg3:#FFB300; --card:#ffffffcc; --txt:#222; --accent:#673AB7;
      --soft-shadow: 0 10px 30px rgba(0,0,0,.15); --good:#2e7d32; --warn:#f9a825; --bad:#c62828;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui; color:var(--txt);
      background: radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent),
                  radial-gradient(1000px 600px at 0% 0%, var(--bg2), transparent),
                  linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg3));
      min-height:100svh; overflow-x:hidden; position:relative;
    }
    header{
      position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; backdrop-filter: blur(8px);
    }
    .brand{display:flex; align-items:center; gap:10px}
    .icons{display:flex; align-items:center; gap:10px}
    .icon-btn{
      background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:8px; display:inline-flex; cursor:pointer;
      box-shadow:var(--soft-shadow);
    }
    .chip{
      background:#fff; padding:8px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.06);
      box-shadow:var(--soft-shadow); display:inline-flex; align-items:center; gap:8px;
    }
    .container{padding:16px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{
      background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--soft-shadow);
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; background:linear-gradient(135deg, #FFB300, #FF8F00);
      color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 20px rgba(255,143,0,.25);
    }
    .status{font-weight:800; padding:6px 10px; border-radius:12px; color:#fff; display:inline-flex; align-items:center; gap:6px}
    .s-good{background:var(--good)}
    .s-warn{background:var(--warn)}
    .s-bad{background:var(--bad)}
    video, canvas, img{width:100%; border-radius:12px; background:#000}
    .fab{
      position:fixed; right:16px; bottom:16px; z-index:6; width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center; background:linear-gradient(135deg,#FF8F00,#FF6F00); color:#fff; box-shadow:var(--soft-shadow);
      cursor:pointer;
    }
    dialog{
      border:none; border-radius:16px; width:min(520px,90vw); padding:0; box-shadow:var(--soft-shadow);
      animation:pop .2s ease; overflow:hidden;
    }
    @keyframes pop{ from{transform:translateY(10px); opacity:.5} to{transform:translateY(0); opacity:1} }
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#fff}
    .dlg-body{padding:14px; background:#fff}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .input{display:flex; align-items:center; gap:8px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:8px 10px}
    .input input, .input select{border:none; outline:none; background:transparent; font-size:14px}
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px;
      border-radius:12px; box-shadow:var(--soft-shadow); z-index:10; display:none; }
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 100;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FFB300;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .notification-item {
      border-left: 4px solid #FFB300;
      padding-left: 10px;
      margin-bottom: 10px;
    }
    .notification-item.unread {
      border-left-color: #673AB7;
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p style="margin-top: 16px;">Memproses...</p>
  </div>

  <header>
    <div class="brand">
      <span class="material-symbols-rounded" style="color:#FF8F00">workspace_premium</span>
      <div>
        <div style="font-weight:800">Presensi Karyawan</div>
        <div id="serverTime" style="font-size:12px; opacity:.8">Memuat waktu server…</div>
      </div>
    </div>
    <div class="icons">
      <button id="notifBtn" class="icon-btn" title="Notifikasi">
        <span class="material-symbols-rounded">notifications</span>
        <span id="notifBadge" style="display:none; position:absolute; top:-5px; right:-5px; background:var(--bad); color:white; border-radius:50%; width:18px; height:18px; font-size:12px; display:grid; place-items:center;"></span>
      </button>
      <button id="profileBtn" class="icon-btn" title="Profil">
        <span class="material-symbols-rounded">account_circle</span>
      </button>
    </div>
  </header>

  <div class="container">
    <div class="grid">
      <section class="card">
        <h3 style="margin:0 0 8px">Ambil presensi</h3>
        <div class="row" style="justify-content:space-between">
          <span id="statusChip" class="status s-warn"><span class="material-symbols-rounded">schedule</span><span id="statusText">Menunggu</span></span>
          <span class="chip"><span class="material-symbols-rounded">pin_drop</span><span id="locText">Koordinat belum aktif</span></span>
        </div>
        <div style="margin-top:10px">
          <video id="cam" playsinline autoplay muted></video>
          <canvas id="canvas" style="display:none"></canvas>
          <img id="preview" style="display:none" alt="Preview selfie" />
        </div>
        <div class="row" style="margin-top:10px">
          <div class="input">
            <span class="material-symbols-rounded">assignment</span>
            <select id="jenis">
              <option value="berangkat">Presensi berangkat</option>
              <option value="pulang">Presensi pulang</option>
            </select>
          </div>
          <button id="snapBtn" class="btn"><span class="material-symbols-rounded">photo_camera</span> Ambil selfie</button>
          <button id="uploadBtn" class="btn"><span class="material-symbols-rounded">cloud_upload</span> Upload</button>
        </div>
        <div class="hint" style="opacity:.8;margin-top:8px">
          Presensi hanya pada 04:30–05:30 (berangkat) dan 10:00–11:00 (pulang). Di luar ini akan ditolak atau ditandai terlambat.
        </div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px">Riwayat singkat</h3>
        <div id="logList" style="display:grid; gap:8px"></div>
      </section>
    </div>
  </div>

  <!-- FAB cuti -->
  <button class="fab" id="cutiFab" title="Ajukan cuti">
    <span class="material-symbols-rounded">event</span>
  </button>

  <!-- Dialog profil -->
  <dialog id="profileDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">account_circle</span><b>Profil</b></div>
      <button class="icon-btn" onclick="document.getElementById('profileDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <div class="row" style="align-items:flex-end">
        <img id="pfp" src="https://api.dicebear.com/7.x/initials/svg?seed=Karyawan&backgroundColor=ffb300,ffd54f&radius=20" alt="Foto profil" style="width:80px;height:80px;border-radius:16px; background:#eee" />
        <div class="input"><span class="material-symbols-rounded">photo</span><input type="file" id="pfpFile" accept="image/*" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">badge</span><input id="nama" placeholder="Nama lengkap" /></div>
        <div class="input" style="flex:1"><span class="material-symbols-rounded">home</span><input id="alamat" placeholder="Alamat" /></div>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:12px">
        <button id="saveProfileBtn" class="btn"><span class="material-symbols-rounded">save</span> Simpan</button>
        <button id="logoutBtn" class="btn" style="background:#222"><span class="material-symbols-rounded">logout</span> Keluar</button>
      </div>
    </div>
  </dialog>

  <!-- Dialog notifikasi -->
  <dialog id="notifDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">notifications</span><b>Notifikasi</b></div>
      <button class="icon-btn" onclick="document.getElementById('notifDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body" id="notifList" style="display:grid; gap:10px; max-height:60vh; overflow-y:auto;"></div>
  </dialog>

  <!-- Dialog cuti -->
  <dialog id="cutiDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">event</span><b>Ajukan cuti</b></div>
      <button class="icon-btn" onclick="document.getElementById('cutiDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <div class="row">
        <div class="input"><span class="material-symbols-rounded">category</span>
          <select id="cutiJenis">
            <option value="izin">Izin</option>
            <option value="sakit">Sakit</option>
            <option value="cuti">Cuti</option>
          </select>
        </div>
        <div class="input"><span class="material-symbols-rounded">today</span><input id="cutiTanggal" type="date" /></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">notes</span><input id="cutiCatatan" placeholder="Keterangan (opsional)" /></div>
        <button id="ajukanCutiBtn" class="btn"><span class="material-symbols-rounded">send</span> Ajukan</button>
      </div>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- app.js must be present and contain PresensiFUPA functions (the file I provided earlier) -->
  <script src="app.js"></script>

  <!-- Page-specific bindings -->
  <script>
    // Minimal local helpers (UI)
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const toast = (m, t=2200) => {
      const el = $("#toast");
      if (!el) return alert(m);
      el.textContent = m;
      el.style.display = "block";
      setTimeout(()=> el.style.display = "none", t);
    };

    // Local getServerTime (same approach as app.js)
    async function getServerTimeLocal() {
      const docRef = firebase.firestore().collection("_meta").doc("_srv");
      await docRef.set({ t: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      const snap = await docRef.get();
      const ts = snap.get("t");
      return ts ? ts.toDate() : new Date();
    }

    // Small getLocation helper
    function getLocation(timeout=8000) {
      return new Promise((res, rej) => {
        if (!navigator.geolocation) return rej(new Error("Geolokasi tidak didukung."));
        navigator.geolocation.getCurrentPosition(
          pos => res({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          err => rej(err),
          { enableHighAccuracy: true, timeout, maximumAge: 2000 }
        );
      });
    }

    // Role sets (keep consistent with app.js)
    const ADMIN_UIDS = new Set([
      "DsBQ1TdWjgXvpVHUQJpF1H6jZzJ3",
      "xxySAjSMqKeq7SC6r5vyzes7USY2"
    ]);
    const KARYAWAN_UIDS = new Set([
      "y2MTtiGZcVcts2MkQncckAaUasm2",
      "4qwoQhWyZmatqkRYaENtz5Uw8fy1",
      "UkIHdrTF6vefeuzp94ttlmxZqk2",
      "kTpmDbdBETQT7HIqT6TvpLwrbQf2",
      "15FESE0b7cQFKqdJSqNBTZlHqWR2",
      "1tQidUDFTjRTJdJJYIudw9928pa2",
      "7BCcTwQ5wDaxWA6xbzJX9VWj1o52",
      "mpyFesOjUIcs8O8Sh3tVLS8x7dA3",
      "2jV2is3MQRhv7nnd1gXeqiaj11t2",
      "or2AQDVY1hdpwT0YOmL4qJrgCju1",
      "HNJ52lywYVaUhRK3BNEARfQsQo22"
    ]);

    // State
    let currentUser = null;
    let localProfile = {};
    let localCoords = null;
    let cameraStream = null;
    let unsubRiwayat = null;
    let unsubNotif = null;

    // Update UI status based on time window and override
    async function evaluateStatus(jenis) {
      try {
        const serverNow = await getServerTimeLocal();
        const todayStr = (new Date(serverNow)).toISOString().slice(0,10);
        // Use app's getScheduleOverride if available
        let overrideMode = "auto";
        if (window.PresensiFUPA && typeof window.PresensiFUPA.getScheduleOverride === "function") {
          overrideMode = await window.PresensiFUPA.getScheduleOverride(todayStr);
        } else {
          // fallback: read _settings/today
          const s = await firebase.firestore().collection("_settings").doc("today").get();
          if (s.exists && s.data().date === todayStr) overrideMode = s.data().mode || "auto";
        }

        const isSunday = serverNow.getDay() === 0;
        let wajib = true;
        if (overrideMode === "forceOn") wajib = true;
        else if (overrideMode === "forceOff") wajib = false;
        else wajib = !isSunday;

        if (!wajib) {
          $("#statusText").textContent = "Hari ini tidak wajib presensi";
          $("#statusChip").className = "status s-warn";
          return { allowed:false, reason:"not-required" };
        }

        // compute in-window
        const WINDOW = {
          berangkat: { start: {h:4,m:30}, end:{h:5,m:30} },
          pulang:    { start: {h:10,m:0}, end:{h:11,m:0} }
        };
        const w = WINDOW[jenis];
        const start = new Date(serverNow); start.setHours(w.start.h, w.start.m, 0, 0);
        const end = new Date(serverNow); end.setHours(w.end.h, w.end.m, 0, 0);
        const lateEnd = new Date(end.getTime() + 30*60000);
        if (serverNow < start) {
          $("#statusText").textContent = "Di luar jam presensi";
          $("#statusChip").className = "status s-bad";
          return { allowed:false, reason:"too_early" };
        }
        if (serverNow >= start && serverNow <= end) {
          $("#statusText").textContent = "Tepat waktu";
          $("#statusChip").className = "status s-good";
          return { allowed:true, status:"tepat", serverNow };
        }
        if (serverNow > end && serverNow <= lateEnd) {
          $("#statusText").textContent = "Terlambat";
          $("#statusChip").className = "status s-warn";
          return { allowed:true, status:"terlambat", serverNow };
        }
        $("#statusText").textContent = "Di luar jam presensi";
        $("#statusChip").className = "status s-bad";
        return { allowed:false, reason:"too_late" };
      } catch (e) {
        console.warn("evaluateStatus error", e);
        $("#statusText").textContent = "Tidak dapat memeriksa jam server";
        $("#statusChip").className = "status s-warn";
        return { allowed:false, reason:"error" };
      }
    }

    // Bindings for page after auth
    async function bindPageForUser(user) {
      currentUser = user;
      $("#loading").style.display = "flex";

      // Ensure profile exists (bootstrap)
      try {
        const usersRef = firebase.firestore().collection("users").doc(user.uid);
        const uSnap = await usersRef.get();
        if (!uSnap.exists) {
          await usersRef.set({
            email: user.email || "",
            role: (ADMIN_UIDS.has(user.uid) ? "admin" : (KARYAWAN_UIDS.has(user.uid) ? "karyawan" : "unknown")),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
        } else {
          // merge lastLogin
          await usersRef.set({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        }
      } catch (e) {
        console.warn("bootstrap user failed", e);
      }

      // Setup server clock using app helper if available
      if (window.PresensiFUPA && typeof window.PresensiFUPA.startServerClock === "function") {
        window.PresensiFUPA.startServerClock("#serverTime");
      } else {
        // fallback: simple tick
        setInterval(async ()=> {
          try {
            const t = await getServerTimeLocal();
            $("#serverTime").textContent = `Waktu server: ${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")} WIB`;
          } catch { $("#serverTime").textContent = "Waktu server: tidak tersedia"; }
        }, 10_000);
      }

      // Load profile
      try {
        const profile = await (window.PresensiFUPA && window.PresensiFUPA.getProfile ? window.PresensiFUPA.getProfile(user.uid) : firebase.firestore().collection("users").doc(user.uid).get().then(s=>s.exists? s.data():{}));
        localProfile = profile || {};
        if (profile.pfp) $("#pfp").src = profile.pfp;
        if (profile.nama) $("#nama").value = profile.nama;
        if (profile.alamat) $("#alamat").value = profile.alamat;
      } catch (e) {
        console.warn("load profile failed", e);
      }

      // Start camera
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: "user" }, audio:false });
        const video = $("#cam");
        video.srcObject = cameraStream;
        await video.play();
      } catch (e) {
        console.warn("camera error", e);
        toast("Tidak bisa mengakses kamera. Periksa izin perangkat.");
      }

      // Get location (best-effort)
      try {
        localCoords = await getLocation();
        $("#locText").textContent = `${localCoords.lat.toFixed(5)}, ${localCoords.lng.toFixed(5)}`;
      } catch {
        $("#locText").textContent = "Lokasi tidak aktif";
        localCoords = null;
      }

      // Subscribe riwayat
      if (unsubRiwayat) unsubRiwayat();
      unsubRiwayat = (window.PresensiFUPA && window.PresensiFUPA.subscribeRiwayat)
        ? window.PresensiFUPA.subscribeRiwayat(user.uid, renderRiwayat)
        : firebase.firestore().collection("presensi").where("uid","==", user.uid).orderBy("createdAt","desc").limit(20).onSnapshot(snap => {
            const arr = []; snap.forEach(d => arr.push({ id:d.id, ...d.data()})); renderRiwayat(arr);
          });

      // Subscribe notifications
      if (unsubNotif) unsubNotif();
      unsubNotif = (window.PresensiFUPA && window.PresensiFUPA.subscribeNotifications)
        ? window.PresensiFUPA.subscribeNotifications(user.uid, renderNotifications)
        : firebase.firestore().collection("notifications").where("userId","in",[user.uid,"all"]).orderBy("createdAt","desc").limit(50).onSnapshot(snap => {
            const arr = []; snap.forEach(d => arr.push({ id:d.id, ...d.data() })); renderNotifications(arr);
          });

      // Bind UI controls
      $("#snapBtn").onclick = () => {
        const video = $("#cam");
        const canvas = $("#canvas");
        // use helper from app if available
        if (window.PresensiFUPA && typeof window.PresensiFUPA.captureToCanvas === "function") {
          window.PresensiFUPA.captureToCanvas(video, canvas);
        } else {
          // local draw
          const w = video.videoWidth || 640;
          const h = video.videoHeight || 480;
          const scale = Math.min(1, 720 / w);
          canvas.width = Math.round(w * scale);
          canvas.height = Math.round(h * scale);
          canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
        }
        canvas.style.display = "block";
        $("#preview").style.display = "none";
        toast("Foto diambil. Anda bisa langsung upload.");
      };

      $("#uploadBtn").onclick = async () => {
        $("#loading").style.display = "flex";
        try {
          const jenis = $("#jenis").value;
          const statusCheck = await evaluateStatus(jenis);
          if (!statusCheck.allowed) {
            toast("Presensi ditolak: di luar jadwal atau tidak wajib.");
            $("#loading").style.display = "none";
            return;
          }
          if (!localCoords) {
            toast("Lokasi belum aktif.");
            $("#loading").style.display = "none";
            return;
          }
          const canvas = $("#canvas");
          if (!canvas || canvas.width === 0 || canvas.height === 0) {
            toast("Ambil selfie dulu.");
            $("#loading").style.display = "none";
            return;
          }

          // compress using app helper if available
          let blob;
          if (window.PresensiFUPA && typeof window.PresensiFUPA.canvasToCompressedBlob === "function") {
            blob = await window.PresensiFUPA.canvasToCompressedBlob(canvas, 30);
          } else {
            // fallback: basic toBlob at quality 0.6
            blob = await new Promise(r => canvas.toBlob(r, "image/jpeg", 0.6));
          }

          // upload
          let url;
          if (window.PresensiFUPA && typeof window.PresensiFUPA.uploadToCloudinary === "function") {
            url = await window.PresensiFUPA.uploadToCloudinary(blob);
          } else {
            // fallback direct upload to cloudinary using constants
            const form = new FormData();
            form.append("file", blob);
            form.append("upload_preset", "presensi_unsigned");
            const resp = await fetch(`https://api.cloudinary.com/v1_1/dn2o2vf04/upload`, { method: "POST", body: form });
            const j = await resp.json();
            url = j.secure_url || j.url;
          }

          $("#preview").src = url;
          $("#preview").style.display = "block";

          // server time
          const serverNow = await getServerTimeLocal();
          const localName = ($("#nama").value || localProfile.nama || (user.email ? user.email.split("@")[0] : "Karyawan")).trim();
          const statusVal = statusCheck.status === "tepat" ? "tepat" : "terlambat";

          // Save presensi using app helper (preferred)
          if (window.PresensiFUPA && typeof window.PresensiFUPA.savePresensi === "function") {
            await window.PresensiFUPA.savePresensi({
              uid: user.uid,
              nama: localName,
              jenis,
              status: statusVal,
              lat: localCoords.lat,
              lng: localCoords.lng,
              selfieUrl: url,
              serverDate: serverNow
            });
          } else {
            // fallback to direct Firestore write
            await firebase.firestore().collection("presensi").add({
              uid: user.uid,
              nama: localName,
              jenis,
              status: statusVal,
              lat: localCoords.lat,
              lng: localCoords.lng,
              selfieUrl: url,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              localTime: `${serverNow.getFullYear()}-${String(serverNow.getMonth()+1).padStart(2,"0")}-${String(serverNow.getDate()).padStart(2,"0")} ${String(serverNow.getHours()).padStart(2,"0")}:${String(serverNow.getMinutes()).padStart(2,"0")}:${String(serverNow.getSeconds()).padStart(2,"0")}`,
              ymd: serverNow.toISOString().slice(0,10)
            });
          }

          toast("Presensi tersimpan.");
        } catch (e) {
          console.error("upload error", e);
          toast("Gagal menyimpan presensi.");
        } finally {
          $("#loading").style.display = "none";
        }
      };

      // Notifications UI
      $("#notifBtn").onclick = () => $("#notifDlg").showModal();

      function renderNotifications(items) {
        const list = $("#notifList");
        list.innerHTML = "";
        const unreadCount = items.filter(i => !i.read).length;
        const badge = $("#notifBadge");
        if (unreadCount > 0) { badge.textContent = unreadCount; badge.style.display = "grid"; } else badge.style.display = "none";

        items.forEach(it => {
          const el = document.createElement("div");
          el.className = `notification-item ${it.read ? "" : "unread"}`;
          el.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div style="font-weight:700">${it.title || "(tanpa judul)"}</div>
              <div>
                <button class="icon-btn mark-read" data-id="${it.id}" title="Tandai dibaca"><span class="material-symbols-rounded">done</span></button>
                <button class="icon-btn del-notif" data-id="${it.id}" title="Hapus"><span class="material-symbols-rounded">close</span></button>
              </div>
            </div>
            <div style="opacity:.8; margin-top:6px">${it.message || ""}</div>
            <div style="font-size:12px; opacity:.6; margin-top:6px">${it.createdAt ? it.createdAt.toDate().toLocaleString() : ""}</div>
          `;
          // mark read
          el.querySelector(".mark-read").onclick = async (ev) => {
            ev.stopPropagation();
            try {
              if (window.PresensiFUPA && window.PresensiFUPA.markNotificationAsRead) {
                await window.PresensiFUPA.markNotificationAsRead(it.id);
              } else {
                await firebase.firestore().collection("notifications").doc(it.id).update({ read: true });
              }
              toast("Notifikasi ditandai dibaca.");
            } catch (e) { console.warn(e); toast("Gagal menandai notifikasi."); }
          };
          // delete
          el.querySelector(".del-notif").onclick = async (ev) => {
            ev.stopPropagation();
            try {
              if (window.PresensiFUPA && window.PresensiFUPA.deleteNotification) {
                await window.PresensiFUPA.deleteNotification(it.id);
              } else {
                await firebase.firestore().collection("notifications").doc(it.id).delete();
              }
              toast("Notifikasi dihapus.");
            } catch (e) { console.warn(e); toast("Gagal menghapus notifikasi."); }
          };

          // clicking item marks read (if unread)
          el.onclick = async () => {
            if (!it.read) {
              try {
                if (window.PresensiFUPA && window.PresensiFUPA.markNotificationAsRead) {
                  await window.PresensiFUPA.markNotificationAsRead(it.id);
                } else {
                  await firebase.firestore().collection("notifications").doc(it.id).update({ read:true });
                }
              } catch {}
            }
          };

          list.appendChild(el);
        });
      }

      // Render riwayat function
      function renderRiwayat(items) {
        const list = $("#logList");
        list.innerHTML = "";
        items.forEach(it => {
          const badge = it.status === "tepat" ? "s-good" : (it.status === "terlambat" ? "s-warn" : "s-bad");
          const el = document.createElement("div");
          el.className = "row";
          el.style.justifyContent = "space-between";
          el.innerHTML = `
            <div class="row" style="gap:8px">
              <span class="material-symbols-rounded">schedule</span>
              <b>${it.localTime || 'Waktu tidak tersedia'}</b>
              <span>•</span>
              <span>${it.jenis}</span>
            </div>
            <span class="status ${badge}">${it.status}</span>
          `;
          list.appendChild(el);
        });
      }

      // Cuti
      $("#cutiFab").onclick = () => $("#cutiDlg").showModal();
      $("#ajukanCutiBtn").onclick = async () => {
        const jenis = $("#cutiJenis").value;
        const tanggal = $("#cutiTanggal").value;
        const catatan = $("#cutiCatatan").value.trim();
        if (!tanggal) { toast("Pilih tanggal cuti."); return; }
        $("#loading").style.display = "flex";
        try {
          if (window.PresensiFUPA && window.PresensiFUPA.ajukanCuti) {
            await window.PresensiFUPA.ajukanCuti(currentUser.uid, ($("#nama").value || localProfile.nama || currentUser.email.split("@")[0]).trim(), jenis, tanggal, catatan);
          } else {
            // fallback
            await firebase.firestore().collection("cuti").add({
              uid: currentUser.uid, nama: ($("#nama").value || localProfile.nama || currentUser.email.split("@")[0]).trim(),
              jenis, tanggal, catatan, status:"menunggu", createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            // notify admin
            await firebase.firestore().collection("notifications").add({
              userId: "admin", type: "cuti", title: "Permintaan Cuti Baru",
              message: `${($("#nama").value || localProfile.nama || currentUser.email.split("@")[0]).trim()} mengajukan ${jenis} pada ${tanggal}`,
              data: {}, read:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          toast("Permintaan cuti dikirim.");
          $("#cutiDlg").close();
        } catch (e) {
          console.error(e);
          toast("Gagal mengajukan cuti.");
        } finally {
          $("#loading").style.display = "none";
        }
      };

      // Profile save
      $("#profileBtn").onclick = () => $("#profileDlg").showModal();
      $("#saveProfileBtn").onclick = async () => {
        $("#loading").style.display = "flex";
        try {
          let pfpUrl;
          const file = $("#pfpFile").files?.[0];
          if (file) {
            // create image element to draw to canvas
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            await new Promise(r => img.onload = r);
            const c = document.createElement("canvas");
            const scale = Math.min(1, 512 / Math.max(img.width, img.height));
            c.width = Math.max(64, Math.round(img.width * scale));
            c.height = Math.max(64, Math.round(img.height * scale));
            const ctx = c.getContext("2d");
            ctx.drawImage(img, 0, 0, c.width, c.height);

            // compress using app helper if available
            let blob;
            if (window.PresensiFUPA && typeof window.PresensiFUPA.canvasToCompressedBlob === "function") {
              blob = await window.PresensiFUPA.canvasToCompressedBlob(c, 30);
            } else {
              blob = await new Promise(r => c.toBlob(r, "image/jpeg", 0.7));
            }

            if (window.PresensiFUPA && typeof window.PresensiFUPA.uploadToCloudinary === "function") {
              pfpUrl = await window.PresensiFUPA.uploadToCloudinary(blob);
            } else {
              const form = new FormData();
              form.append("file", blob);
              form.append("upload_preset", "presensi_unsigned");
              const resp = await fetch(`https://api.cloudinary.com/v1_1/dn2o2vf04/upload`, { method:"POST", body: form });
              const j = await resp.json();
              pfpUrl = j.secure_url || j.url;
            }
            $("#pfp").src = pfpUrl;
          }

          const nama = $("#nama").value.trim();
          const alamat = $("#alamat").value.trim();
          if (window.PresensiFUPA && typeof window.PresensiFUPA.saveProfile === "function") {
            await window.PresensiFUPA.saveProfile(currentUser.uid, { nama, alamat, pfpUrl });
          } else {
            await firebase.firestore().collection("users").doc(currentUser.uid).set({ nama, alamat, pfp: pfpUrl, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          }
          toast("Profil tersimpan.");
        } catch (e) {
          console.error(e);
          toast("Gagal menyimpan profil.");
        } finally {
          $("#loading").style.display = "none";
        }
      };

      // Logout
      $("#logoutBtn").onclick = async () => {
        $("#loading").style.display = "flex";
        try {
          await firebase.auth().signOut();
          location.href = "index.html";
        } catch (e) {
          console.warn(e);
        } finally {
          $("#loading").style.display = "none";
        }
      };

      // hide loading
      $("#loading").style.display = "none";
    }

    // Auth state handling
    firebase.auth().onAuthStateChanged(async (user) => {
      const path = location.pathname.toLowerCase();
      if (!user) {
        // redirect to index
        if (path.endsWith("karyawan.html")) location.href = "index.html";
        return;
      }

      // quick role check: prevent admin accessing karyawan page
      if (ADMIN_UIDS.has(user.uid)) {
        // admin account, redirect to admin panel
        location.href = "admin.html";
        return;
      }

      // validate session record if app helper exists
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.checkSessionValidity === "function") {
          const valid = await window.PresensiFUPA.checkSessionValidity();
          if (!valid) {
            await firebase.auth().signOut();
            toast("Sesi tidak valid. Silakan login kembali.");
            return;
          }
        }
      } catch (e) {
        console.warn("session check error", e);
      }

      // bind page for user
      await bindPageForUser(user);
    });

    // Clean up on leave
    window.addEventListener("beforeunload", () => {
      try { cameraStream && cameraStream.getTracks().forEach(t=>t.stop()); } catch {}
      unsubRiwayat && unsubRiwayat();
      unsubNotif && unsubNotif();
    });

    // register service worker if available
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
    }
  </script>
</body>
</html>