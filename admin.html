<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Presensi FUPA — Admin</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFC107" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#FFF59D; --bg2:#FFD54F; --bg3:#FFB300; --card:#ffffffcc; --txt:#222; --accent:#673AB7;
      --soft-shadow: 0 10px 30px rgba(0,0,0,.15); --good:#2e7d32; --warn:#f9a825; --bad:#c62828;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui; color:var(--txt);
      background: radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent),
                  radial-gradient(1000px 600px at 0% 0%, var(--bg2), transparent),
                  linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg3));
      min-height:100svh; overflow-x:hidden; position:relative;
    }
    header{ position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; backdrop-filter: blur(8px); }
    .brand{display:flex; align-items:center; gap:10px}
    .icons{display:flex; align-items:center; gap:10px}
    .icon-btn{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:14px; padding:8px; display:inline-flex; cursor:pointer;
      box-shadow:var(--soft-shadow); }
    .container{ padding:16px }
    .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:var(--soft-shadow); }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px }
    @media(min-width:1024px){ .grid{ grid-template-columns:1fr .7fr } }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .input{ display:flex; align-items:center; gap:8px; background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:8px 10px }
    .input input, .input select, .input textarea{ border:none; outline:none; background:transparent; font-size:14px }
    .btn{
      display:inline-flex; align-items:center; gap:8px; background:linear-gradient(135deg, #FFB300, #FF8F00);
      color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 20px rgba(255,143,0,.25);
    }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    th, td{ text-align:left; padding:10px 12px; background:#fff }
    th{ position:sticky; top:0; z-index:1 }
    tr{ box-shadow:0 1px 0 rgba(0,0,0,.06) }
    .fab{
      position:fixed; right:16px; bottom:16px; z-index:6; width:56px; height:56px; border-radius:50%;
      display:grid; place-items:center; background:linear-gradient(135deg,#FF8F00,#FF6F00); color:#fff; box-shadow:var(--soft-shadow);
      cursor:pointer;
    }
    dialog{ border:none; border-radius:16px; width:min(720px,92vw); padding:0; box-shadow:var(--soft-shadow); overflow:hidden; }
    .dlg-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:#fff}
    .dlg-body{padding:14px; background:#fff}
    .status{font-weight:800; padding:6px 10px; border-radius:12px; color:#fff; display:inline-flex; align-items:center; gap:6px}
    .s-good{background:var(--good)} .s-warn{background:var(--warn)} .s-bad{background:var(--bad)}
    .toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px;
      border-radius:12px; box-shadow:var(--soft-shadow); z-index:10; display:none; }
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 100;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FFB300;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .pagination { display:flex; justify-content:center; margin-top:16px; gap:8px; }
    .pagination button { background:#fff; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:8px 12px; cursor:pointer; }
    .pagination button.active { background:#FFB300; color:#fff; }
    .notification-item { border-left:4px solid #FFB300; padding-left:10px; margin-bottom:10px; }
    .notification-item.unread { border-left-color:#673AB7; background:#f9f9f9; }
    .override-section { margin-top:16px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.1); }
    .small { font-size:13px; opacity:.8 }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p style="margin-top:16px">Memproses...</p>
  </div>

  <header>
    <div class="brand">
      <span class="material-symbols-rounded" style="color:#FF8F00">workspace_premium</span>
      <div>
        <div style="font-weight:800">Panel Admin</div>
        <div id="serverTime" style="font-size:12px; opacity:.8">Memuat waktu server…</div>
      </div>
    </div>
    <div class="icons">
      <button id="notifBtn" class="icon-btn" title="Permintaan cuti">
        <span class="material-symbols-rounded">notifications_active</span>
        <span id="notifBadge" style="display:none; position:absolute; top:-5px; right:-5px; background:var(--bad); color:white; border-radius:50%; width:18px; height:18px; font-size:12px; display:grid; place-items:center;"></span>
      </button>
      <button id="profileBtn" class="icon-btn" title="Profil & akun">
        <span class="material-symbols-rounded">admin_panel_settings</span>
      </button>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Riwayat presensi</h3>
          <div class="row">
            <div class="input"><span class="material-symbols-rounded">person_search</span><input id="fNama" placeholder="Filter nama" /></div>
            <div class="input"><span class="material-symbols-rounded">today</span><input id="fTanggal" type="date" /></div>
            <div class="input">
              <span class="material-symbols-rounded">calendar_today</span>
              <select id="fPeriode">
                <option value="semua">Semua Periode</option>
                <option value="hari">Hari Ini</option>
                <option value="minggu">Minggu Ini</option>
                <option value="bulan">Bulan Ini</option>
                <option value="tahun">Tahun Ini</option>
              </select>
            </div>
            <button id="applyFilter" class="btn"><span class="material-symbols-rounded">filter_alt</span> Terapkan</button>
            <button id="exportCsv" class="btn"><span class="material-symbols-rounded">download</span> Ekspor CSV</button>
          </div>
        </div>

        <div style="max-height:60vh; overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Waktu</th><th>Nama</th><th>Jenis</th><th>Status</th><th>Koordinat</th><th>Selfie</th><th>Aksi</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
        <div class="pagination" id="pagination"></div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px">Pengaturan & pengumuman</h3>

        <div class="row">
          <div class="input">
            <span class="material-symbols-rounded">event_busy</span>
            <select id="wajibHari">
              <option value="auto">Sesuai aturan: Minggu non-presensi</option>
              <option value="forceOn">Paksa wajib presensi hari ini</option>
              <option value="forceOff">Paksa tidak wajib presensi hari ini</option>
            </select>
          </div>
          <button id="saveSchedule" class="btn"><span class="material-symbols-rounded">save</span> Simpan</button>
        </div>

        <div class="override-section">
          <h4 style="margin:0 0 8px">Override Status Presensi</h4>
          <div class="row">
            <div class="input">
              <span class="material-symbols-rounded">calendar_today</span>
              <input id="overrideTanggal" type="date" />
            </div>
            <div class="input">
              <span class="material-symbols-rounded">settings</span>
              <select id="overrideStatus">
                <option value="libur">Libur</option>
                <option value="masuk">Masuk</option>
                <option value="wajib">Wajib Presensi</option>
                <option value="tidak-wajib">Tidak Wajib Presensi</option>
              </select>
            </div>
            <button id="applyOverride" class="btn"><span class="material-symbols-rounded">settings</span> Terapkan Override</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="input" style="flex:1"><span class="material-symbols-rounded">campaign</span>
            <textarea id="announceText" placeholder="Tulis pengumuman untuk karyawan" rows="3" style="width:100%"></textarea>
          </div>
          <button id="sendAnnounce" class="btn"><span class="material-symbols-rounded">send</span> Kirim</button>
        </div>
      </section>
    </div>
  </main>

  <!-- FAB pengumuman cepat -->
  <button class="fab" id="announceFab" title="Pengumuman"><span class="material-symbols-rounded">campaign</span></button>

  <!-- Dialog profil admin + create akun -->
  <dialog id="profileDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">admin_panel_settings</span><b>Profil & Akun</b></div>
      <button class="icon-btn" onclick="document.getElementById('profileDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <div class="row" style="align-items:flex-end">
        <img id="pfp" src="https://api.dicebear.com/7.x/initials/svg?seed=Admin&backgroundColor=ffb300,ffd54f&radius=20" alt="Foto profil" style="width:80px;height:80px;border-radius:16px; background:#eee" />
        <div class="input"><span class="material-symbols-rounded">photo</span><input type="file" id="pfpFile" accept="image/*" /></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">badge</span><input id="nama" placeholder="Nama admin" /></div>
        <div class="input" style="flex:1"><span class="material-symbols-rounded">home</span><input id="alamat" placeholder="Alamat" /></div>
      </div>

      <div class="row" style="justify-content:space-between; margin-top:12px">
        <button id="saveProfileBtn" class="btn"><span class="material-symbols-rounded">save</span> Simpan</button>
        <button id="logoutBtn" class="btn" style="background:#222"><span class="material-symbols-rounded">logout</span> Keluar</button>
      </div>

      <hr style="margin:16px 0; opacity:.3" />

      <h4 style="margin:0 0 8px">Buat akun karyawan</h4>
      <div class="row">
        <div class="input" style="flex:1"><span class="material-symbols-rounded">mail</span><input id="newEmail" placeholder="Email karyawan" /></div>
        <div class="input" style="flex:1"><span class="material-symbols-rounded">lock</span><input id="newPass" placeholder="Kata sandi sementara" /></div>
        <button id="createUserBtn" class="btn"><span class="material-symbols-rounded">person_add</span> Buat</button>
      </div>
      <div class="hint small" style="margin-top:6px">Akun dibuat tanpa keluar dari sesi admin.</div>
    </div>
  </dialog>

  <!-- Dialog konfirmasi UID -->
  <dialog id="confirmUidDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">person_add</span><b>Konfirmasi UID</b></div>
      <button class="icon-btn" onclick="document.getElementById('confirmUidDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body">
      <p>Akun berhasil dibuat! Salin UID berikut dan simpan pada daftar karyawan jika perlu:</p>
      <div class="input" style="margin:10px 0">
        <input id="newUid" type="text" readonly />
        <button class="btn" id="copyUidBtn">Salin</button>
      </div>
      <button class="btn" onclick="document.getElementById('confirmUidDlg').close()">Selesai</button>
    </div>
  </dialog>

  <!-- Dialog permintaan cuti -->
  <dialog id="notifDlg">
    <div class="dlg-head">
      <div class="row"><span class="material-symbols-rounded">approval</span><b>Permintaan cuti</b></div>
      <button class="icon-btn" onclick="document.getElementById('notifDlg').close()"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="dlg-body" id="cutiList" style="display:grid; gap:10px; max-height:60vh; overflow-y:auto"></div>
  </dialog>

  <div class="toast" id="toast"></div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- load core helper (app.js) if present -->
  <script src="app.js"></script>

  <script>
    // --- small utilities ---
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const showToast = (msg, t=2200) => {
      const el = $("#toast");
      if (!el) return alert(msg);
      el.textContent = msg; el.style.display = "block";
      setTimeout(()=> el.style.display = "none", t);
    };

    // Admin UID set (mirror app.js)
    const ADMIN_UIDS = new Set(["DsBQ1TdWjgXvpVHUQJpF1H6jZzJ3","xxySAjSMqKeq7SC6r5vyzes7USY2"]);

    // state
    let currentUser = null;
    let lastData = [];
    let currentPage = 1;
    const pageSize = 20;
    let unsubCuti = null;
    let unsubNotif = null;

    // small date utilities
    function pad(n){ return n.toString().padStart(2,'0'); }
    function fmtDateTime(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
    function todayYMD(d=new Date()){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    // server time (uses helper if present)
    async function getServerTime() {
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.getServerTime === "function") {
          return await window.PresensiFUPA.getServerTime();
        }
      } catch(e){ console.warn(e); }
      const docRef = firebase.firestore().collection("_meta").doc("_srv");
      await docRef.set({ t: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      const snap = await docRef.get();
      return snap.get('t') ? snap.get('t').toDate() : new Date();
    }

    // bootstrap minimal (if app.js has an implementation, that will be used)
    async function bootstrapCollections(user){
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.bootstrapCollections === "function") {
          return await window.PresensiFUPA.bootstrapCollections(user);
        }
      } catch(e){ console.warn(e); }
      const up = firebase.firestore().collection("users").doc(user.uid);
      await up.set({ email: user.email||"", role: ADMIN_UIDS.has(user.uid) ? "admin" : "unknown", createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      await firebase.firestore().collection("_meta").doc("_srv").set({ t: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      const todayDoc = firebase.firestore().collection("_settings").doc("today");
      if (!(await todayDoc.get()).exists) await todayDoc.set({ mode:"auto", date: todayYMD() });
    }

    // RENDER functions for table and pagination
    function renderPagination(totalItems){
      const totalPages = Math.ceil(totalItems / pageSize);
      const p = $("#pagination"); p.innerHTML = "";
      if (totalPages <= 1) return;
      for (let i=1;i<=totalPages;i++){
        const b = document.createElement("button");
        b.textContent = i; if (i===currentPage) b.classList.add("active");
        b.onclick = ()=>{ currentPage = i; renderTable(lastData, currentPage); };
        p.appendChild(b);
      }
    }

    function renderTable(data, page){
      const start = (page-1)*pageSize, end = start+pageSize;
      const slice = data.slice(start,end);
      const tb = $("#tableBody"); tb.innerHTML = "";
      slice.forEach(r=>{
        const badge = r.status==="tepat" ? "s-good" : (r.status==="terlambat" ? "s-warn" : "s-bad");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.localTime || ""}</td>
          <td>${r.nama || r.uid}</td>
          <td>${r.jenis}</td>
          <td><span class="status ${badge}">${r.status}</span></td>
          <td>${(r.lat?.toFixed?.(5) || "")} ${(r.lng?.toFixed?.(5) ? ', ' + r.lng.toFixed(5) : '')}</td>
          <td>${r.selfieUrl ? `<a href="${r.selfieUrl}" target="_blank">Lihat</a>` : "-"}</td>
          <td><button class="btn delete-presensi" data-id="${r.id}" style="background:var(--bad); padding:6px 10px; font-size:12px;">Hapus</button></td>
        `;
        tb.appendChild(tr);
      });

      // bind delete
      $$(".delete-presensi").forEach(btn=>{
        btn.onclick = async ()=> {
          const id = btn.dataset.id;
          if (!confirm("Hapus data presensi ini?")) return;
          $("#loading").style.display = "flex";
          try {
            if (window.PresensiFUPA && typeof window.PresensiFUPA.deletePresensi === "function") {
              await window.PresensiFUPA.deletePresensi(id);
            } else {
              const doc = await firebase.firestore().collection("presensi").doc(id).get();
              const data = doc.exists ? doc.data() : {};
              await firebase.firestore().collection("presensi").doc(id).delete();
              await firebase.firestore().collection("security_logs").add({ type:"presensi_delete", presensiId:id, uid:data.uid||null, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            }
            showToast("Presensi dihapus.");
            await loadPresensi();
          } catch(e){ console.error(e); showToast("Gagal menghapus presensi."); } finally { $("#loading").style.display = "none"; }
        };
      });
    }

    // Load presensi with client-side filtering
    async function loadPresensi(){
      $("#loading").style.display = "flex";
      try {
        let q = firebase.firestore().collection("presensi").orderBy("createdAt","desc");
        const nama = $("#fNama").value.trim().toLowerCase();
        const tanggal = $("#fTanggal").value;
        const periode = $("#fPeriode").value;

        if (periode && periode !== "semua") {
          const now = new Date(); let start = new Date();
          switch(periode){
            case "hari": start.setHours(0,0,0,0); break;
            case "minggu": start.setDate(now.getDate()-7); break;
            case "bulan": start.setMonth(now.getMonth()-1); break;
            case "tahun": start.setFullYear(now.getFullYear()-1); break;
          }
          q = q.where("createdAt", ">=", start);
        }

        const snap = await q.get();
        const arr = []; snap.forEach(d => arr.push({ id:d.id, ...d.data() }));
        let filtered = arr;
        if (tanggal) filtered = filtered.filter(x => x.ymd === tanggal);
        if (nama) filtered = filtered.filter(x => (x.nama||"").toLowerCase().includes(nama));
        lastData = filtered;
        renderPagination(filtered.length);
        renderTable(filtered, currentPage);
      } catch(e){ console.error(e); showToast("Gagal memuat data presensi."); } finally { $("#loading").style.display = "none"; }
    }

    // Subscribe cuti requests (admin)
    function subscribeCuti(cb){
      return firebase.firestore().collection("cuti").where("status","==","menunggu").orderBy("createdAt","desc").limit(50).onSnapshot(snap=>{
        const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() })); cb(arr);
      });
    }

    // Set cuti status and notify user; uses app.js helper if present
    async function setCutiStatus(id, status){
      $("#loading").style.display = "flex";
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.setCutiStatus === "function") {
          await window.PresensiFUPA.setCutiStatus(id, status, currentUser.uid);
        } else {
          const cutiDoc = await firebase.firestore().collection("cuti").doc(id).get();
          const cutiData = cutiDoc.exists ? cutiDoc.data() : null;
          await firebase.firestore().collection("cuti").doc(id).set({ status }, { merge:true });
          if (status === "disetujui" && cutiData) {
            await firebase.firestore().collection("presensi").add({
              uid: cutiData.uid, nama: cutiData.nama, jenis: cutiData.jenis, status: cutiData.jenis,
              lat: null, lng: null, selfieUrl: "", createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              localTime: `${cutiData.tanggal} 00:00:00`, ymd: cutiData.tanggal, isCuti: true
            });
          }
          if (cutiData) {
            await firebase.firestore().collection("notifications").add({
              userId: cutiData.uid, type:"cuti", title:"Status Cuti", message:`Cuti Anda pada ${cutiData.tanggal} telah ${status}`,
              data:{ cutiId:id, status }, read:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
        }
        showToast(`Cuti ${status}.`);
      } catch(e){ console.error(e); showToast("Gagal memperbarui status cuti."); } finally { $("#loading").style.display = "none"; }
    }

    // Render cuti list in dialog
    function renderCutiList(items){
      const list = $("#cutiList"); list.innerHTML = "";
      const badge = $("#notifBadge");
      if (items.length>0){ badge.textContent = items.length; badge.style.display = "grid"; } else badge.style.display = "none";

      items.forEach(it=>{
        const el = document.createElement("div"); el.className = "card";
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="material-symbols-rounded">person</span><b>${it.nama || it.uid}</b>
              <span>•</span><span>${it.jenis}</span><span>•</span><span>${it.tanggal}</span>
            </div>
            <div class="row"><span class="status ${it.status==='menunggu'?'s-warn':(it.status==='disetujui'?'s-good':'s-bad')}">${it.status}</span></div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:8px">
            <button class="btn" data-act="approve" data-id="${it.id}"><span class="material-symbols-rounded">check</span> Setujui</button>
            <button class="btn" data-act="reject" data-id="${it.id}" style="background:#222"><span class="material-symbols-rounded">close</span> Tolak</button>
          </div>
        `;
        list.appendChild(el);
      });

      // bind actions
      $$("[data-act='approve']").forEach(b=>b.onclick = async ()=>{ const id=b.dataset.id; $("#loading").style.display="flex"; try{ await setCutiStatus(id,"disetujui"); }catch(e){console.error(e); showToast("Gagal menyetujui");} finally{$("#loading").style.display="none"} });
      $$("[data-act='reject']").forEach(b=>b.onclick = async ()=>{ const id=b.dataset.id; $("#loading").style.display="flex"; try{ await setCutiStatus(id,"ditolak"); }catch(e){console.error(e); showToast("Gagal menolak");} finally{$("#loading").style.display="none"} });
    }

    // Notifications (admin): subscribe to admin & all
    function subscribeAdminNotifications(cb){
      return firebase.firestore().collection("notifications").where("userId","in",["admin","all"]).orderBy("createdAt","desc").limit(50).onSnapshot(snap=>{
        const arr=[]; snap.forEach(d=>arr.push({ id:d.id, ...d.data() })); cb(arr);
      });
    }

    // Delete notification
    async function deleteNotification(id){
      await firebase.firestore().collection("notifications").doc(id).delete();
      showToast("Notifikasi dihapus");
    }
    async function markNotificationRead(id){ await firebase.firestore().collection("notifications").doc(id).update({ read:true }); }

    // Pengumuman (broadcast)
    async function kirimPengumuman(text){
      $("#loading").style.display = "flex";
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.kirimPengumuman === "function") {
          await window.PresensiFUPA.kirimPengumuman(text, currentUser.uid);
        } else {
          await firebase.firestore().collection("notifications").add({
            userId: "all", type:"pengumuman", title:"Pengumuman", message:text,
            data:{ from: currentUser.uid }, read:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        showToast("Pengumuman terkirim.");
      } catch(e){ console.error(e); showToast("Gagal mengirim pengumuman."); } finally { $("#loading").style.display = "none"; }
    }

    // Override status for specific date
    async function applyOverride(date, status){
      $("#loading").style.display = "flex";
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.setOverrideStatus === "function") {
          await window.PresensiFUPA.setOverrideStatus(date, status, currentUser.uid);
        } else {
          await firebase.firestore().collection("overrides").doc(date).set({ status, createdBy: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
          await firebase.firestore().collection("notifications").add({
            userId:"all", type:"override", title:"Override Status Presensi",
            message:`Admin mengoverride status presensi pada ${date} menjadi ${status}`,
            data:{ date, status, adminUid: currentUser.uid }, read:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        showToast("Override diterapkan.");
      } catch(e){ console.error(e); showToast("Gagal menerapkan override."); } finally { $("#loading").style.display = "none"; }
    }

    // Save today settings
    async function setHariMode(mode, dateStr){
      $("#loading").style.display = "flex";
      try {
        if (window.PresensiFUPA && typeof window.PresensiFUPA.setHariMode === "function") {
          await window.PresensiFUPA.setHariMode(mode, dateStr);
        } else {
          await firebase.firestore().collection("_settings").doc("today").set({ mode, date: dateStr }, { merge:true });
        }
        showToast("Pengaturan hari tersimpan.");
      } catch(e){ console.error(e); showToast("Gagal menyimpan pengaturan."); } finally { $("#loading").style.display = "none"; }
    }

    // Save profile (admin) with optional Cloudinary upload (uses app.js helpers when available)
    async function saveProfile(uid, { nama, alamat, pfpFile }){
      $("#loading").style.display = "flex";
      try {
        let pfpUrl;
        if (pfpFile) {
          // compress via helper or basic canvas compress
          let blob;
          if (window.PresensiFUPA && typeof window.PresensiFUPA.canvasToCompressedBlob === "function") {
            // build image to canvas
            const img = document.createElement("img");
            img.src = URL.createObjectURL(pfpFile);
            await new Promise(r=>img.onload=r);
            const c = document.createElement("canvas");
            const scale = Math.min(1, 512 / Math.max(img.width, img.height));
            c.width = Math.max(64, Math.round(img.width * scale));
            c.height = Math.max(64, Math.round(img.height * scale));
            const ctx = c.getContext("2d"); ctx.drawImage(img,0,0,c.width,c.height);
            blob = await window.PresensiFUPA.canvasToCompressedBlob(c, 30);
          } else {
            // simple resize & quality step
            const img = document.createElement("img");
            img.src = URL.createObjectURL(pfpFile);
            await new Promise(r=>img.onload=r);
            const c = document.createElement("canvas");
            const scale = Math.min(1, 512 / Math.max(img.width, img.height));
            c.width = Math.max(64, Math.round(img.width * scale));
            c.height = Math.max(64, Math.round(img.height * scale));
            const ctx = c.getContext("2d"); ctx.drawImage(img,0,0,c.width,c.height);
            blob = await new Promise(r=>c.toBlob(r,"image/jpeg",0.7));
          }

          if (window.PresensiFUPA && typeof window.PresensiFUPA.uploadToCloudinary === "function") {
            pfpUrl = await window.PresensiFUPA.uploadToCloudinary(blob);
          } else {
            const form = new FormData();
            form.append("file", blob);
            form.append("upload_preset", "presensi_unsigned");
            const res = await fetch(`https://api.cloudinary.com/v1_1/dn2o2vf04/upload`, { method:"POST", body: form });
            const j = await res.json();
            pfpUrl = j.secure_url || j.url;
          }
        }

        // write profile
        if (window.PresensiFUPA && typeof window.PresensiFUPA.saveProfile === "function") {
          await window.PresensiFUPA.saveProfile(uid, { nama, alamat, pfpUrl });
        } else {
          const d = {}; if (nama!==undefined) d.nama = nama; if (alamat!==undefined) d.alamat = alamat; if (pfpUrl!==undefined) d.pfp = pfpUrl;
          d.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          await firebase.firestore().collection("users").doc(uid).set(d, { merge:true });
        }
        showToast("Profil tersimpan.");
      } catch(e){ console.error(e); showToast("Gagal menyimpan profil."); } finally { $("#loading").style.display = "none"; }
    }

    // Create karyawan account without logging out admin (secondary auth instance)
    async function createUserByAdmin(email, password){
      $("#loading").style.display = "flex";
      try {
        const config = firebase.app().options;
        const secondApp = firebase.apps.length > 1 ? firebase.apps[1] : firebase.initializeApp(config, "second");
        const secondAuth = secondApp.auth();
        const cred = await secondAuth.createUserWithEmailAndPassword(email, password);
        const uid = cred.user.uid;
        // create user doc
        await firebase.firestore().collection("users").doc(uid).set({ email, role:"karyawan", createdBy: currentUser.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        // show UID dialog
        $("#newUid").value = uid;
        document.getElementById("confirmUidDlg").showModal();
        await secondAuth.signOut();
        showToast("Akun karyawan dibuat.");
      } catch(e){ console.error(e); showToast("Gagal membuat akun karyawan."); } finally { $("#loading").style.display = "none"; }
    }

    // CSV util
    function toCSV(rows, columns){ const esc=v=>`"${(v??"").toString().replace(/"/g,'""')}"`; return columns.map(esc).join(",") + "\n" + rows.map(r=>columns.map(k=>esc(r[k])).join(",")).join("\n"); }
    function downloadFile(name, content){ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([content], { type:"text/csv" })); a.download=name; a.click(); }

    // Bind UI actions & main flow (auth)
    firebase.auth().onAuthStateChanged(async (user)=>{
      const path = location.pathname.toLowerCase();
      if (!user) { if (path.endsWith("admin.html") || path.endsWith("karyawan.html")) location.href = "index.html"; return; }
      // verify admin
      if (!ADMIN_UIDS.has(user.uid)) { location.href = "karyawan.html"; return; }
      currentUser = user;
      // session validation if app.js has helper
      try { if (window.PresensiFUPA && typeof window.PresensiFUPA.checkSessionValidity === "function") { const ok = await window.PresensiFUPA.checkSessionValidity(); if (!ok) { await firebase.auth().signOut(); showToast("Sesi tidak valid. Silakan login kembali."); return; } } } catch(e){ console.warn(e); }

      // bootstrap
      $("#loading").style.display = "flex";
      try {
        await bootstrapCollections(user);
        // server time clock
        if (window.PresensiFUPA && typeof window.PresensiFUPA.startServerClock === "function") {
          window.PresensiFUPA.startServerClock("#serverTime");
        } else {
          // simple fallback clock tick (10s)
          const tick = async ()=> { try{ const t = await getServerTime(); $("#serverTime").textContent = `Waktu server: ${fmtDateTime(t)} WIB`; }catch{ $("#serverTime").textContent = "Waktu server: tidak tersedia"; } };
          await tick(); setInterval(tick, 10000);
        }

        // load profile if exists
        try {
          const snap = await firebase.firestore().collection("users").doc(user.uid).get();
          const profile = snap.exists ? snap.data() : {};
          if (profile.pfp) $("#pfp").src = profile.pfp;
          if (profile.nama) $("#nama").value = profile.nama;
          if (profile.alamat) $("#alamat").value = profile.alamat;
        } catch(e){ console.warn("load profile error", e); }

        // subscriptions
        if (unsubCuti) unsubCuti(); unsubCuti = subscribeCuti(renderCutiList);
        if (unsubNotif) unsubNotif(); unsubNotif = subscribeAdminNotifications(items=>{ /* we update badge via cuti list or other handlers */ console.debug('admin notifications', items); });

        // load initial presensi
        await loadPresensi();
        setInterval(loadPresensi, 20000);

        // UI binds
        $("#applyFilter").onclick = ()=>{ currentPage=1; loadPresensi(); };
        $("#exportCsv").onclick = ()=>{ if (!lastData.length){ showToast("Tidak ada data untuk diekspor."); return; } const cols=["localTime","nama","jenis","status","lat","lng","selfieUrl","uid","ymd"]; const csv = toCSV(lastData, cols); downloadFile(`presensi_${Date.now()}.csv`, csv); };

        $("#profileBtn").onclick = ()=>$("#profileDlg").showModal();
        $("#saveProfileBtn").onclick = async ()=>{ const pfpFile = $("#pfpFile").files?.[0]; await saveProfile(currentUser.uid, { nama: $("#nama").value.trim(), alamat: $("#alamat").value.trim(), pfpFile }); };

        $("#createUserBtn").onclick = async ()=>{ const e=$("#newEmail").value.trim(), p=$("#newPass").value.trim(); if(!e||!p){ showToast("Isi email dan kata sandi."); return;} await createUserByAdmin(e,p); };
        $("#copyUidBtn").onclick = ()=>{ const input=$("#newUid"); input.select(); document.execCommand("copy"); showToast("UID disalin ke clipboard"); };

        $("#applyOverride").onclick = async ()=>{ const d=$("#overrideTanggal").value, s=$("#overrideStatus").value; if(!d){ showToast("Pilih tanggal terlebih dahulu."); return; } await applyOverride(d,s); };
        $("#saveSchedule").onclick = async ()=>{ const mode = $("#wajibHari").value; const now = await getServerTime(); await setHariMode(mode, todayYMD(now)); };

        $("#sendAnnounce").onclick = async ()=>{ const text=$("#announceText").value.trim(); if(!text){ showToast("Tulis isi pengumuman."); return; } await kirimPengumuman(text); $("#announceText").value=""; };
        $("#announceFab").onclick = async ()=>{ const text = prompt("Tulis pengumuman:"); if (!text) return; await kirimPengumuman(text); };

        $("#notifBtn").onclick = ()=> $("#notifDlg").showModal();
        $("#logoutBtn").onclick = async ()=>{ $("#loading").style.display="flex"; try{ await firebase.auth().signOut(); location.href="index.html"; }catch(e){console.warn(e);} finally{ $("#loading").style.display="none"; } };

        // enhance: clicking a notification in cutiList can mark it read or be deleted via small UI improvements (admins mostly act on cuti)
      } catch(e){ console.error(e); showToast("Gagal memuat panel admin."); } finally { $("#loading").style.display = "none"; }
    });

    // cleanup
    window.addEventListener("beforeunload", ()=>{ unsubCuti && unsubCuti(); unsubNotif && unsubNotif(); });

    // service worker register (optional)
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); }
  </script>
</body>
</html>