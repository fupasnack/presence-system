<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://fonts.googleapis.com https://fonts.gstatic.com https://apis.google.com; script-src 'self' 'unsafe-inline' https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; connect-src 'self' https://www.googleapis.com https://securetoken.googleapis.com https://firestore.googleapis.com https://api.cloudinary.com https://api.ipify.org;" />
  <title>Presensi FUPA — Masuk</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#FFC107" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:FILL,GRAD@1,200" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#FFF59D; --bg2:#FFD54F; --bg3:#FFB300;
      --card:#ffffffcc; --txt:#222; --accent:#673AB7; --good:#2e7d32; --warn:#f9a825; --bad:#c62828;
      --soft-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto; color:var(--txt);
      background: radial-gradient(1200px 800px at 80% -10%, var(--bg3), transparent),
                  radial-gradient(1000px 600px at 0% 0%, var(--bg2), transparent),
                  linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg3));
      min-height:100svh; overflow:hidden; position:relative;
    }
    .glow{
      position:absolute; inset:0; pointer-events:none; mix-blend-mode:multiply; filter:blur(40px);
      background:
        radial-gradient(600px 400px at 20% 80%, rgba(255,255,255,.35), transparent),
        radial-gradient(400px 300px at 80% 20%, rgba(255,255,255,.25), transparent);
      animation: shimmer 10s ease-in-out infinite alternate;
    }
    @keyframes shimmer{ from{opacity:.7; transform:translateY(-10px)} to{opacity:1; transform:translateY(10px)} }
    .wrap{
      position:relative; z-index:2; display:grid; place-items:center; min-height:100svh; padding:24px;
    }
    .card{
      width:min(520px, 92vw); background:var(--card); border-radius:20px; box-shadow:var(--soft-shadow);
      backdrop-filter: blur(8px); padding:24px; overflow:hidden; position:relative;
    }
    .card::before{
      content:""; position:absolute; inset:0; background:linear-gradient(135deg, rgba(255,255,255,.3), transparent);
      mask: linear-gradient(#000 50%, transparent); pointer-events:none;
    }
    h1{margin:0 0 8px; font-weight:800; letter-spacing:.2px}
    p.sub{margin:0 0 16px; opacity:.8}
    .input{
      display:flex; align-items:center; gap:10px; background:#fff; border-radius:14px; padding:12px 14px; margin:12px 0;
      border:1px solid rgba(0,0,0,.06);
    }
    .input input{
      width:100%; border:none; outline:none; font-size:16px; background:transparent;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:8px}
    .btn{
      display:inline-flex; align-items:center; gap:10px; border:none; cursor:pointer; border-radius:14px;
      padding:12px 16px; font-weight:700; color:#fff; background:linear-gradient(135deg, #FFB300, #FF8F00);
      box-shadow:0 10px 20px rgba(255,143,0,.25); transition:transform .15s ease, filter .2s ease;
    }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .hint{ font-size:13px; opacity:.75; }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111; color:#fff; padding:10px 14px;
      border-radius:12px; box-shadow:var(--soft-shadow); z-index:10; display:none;
    }
    .brand{
      display:flex; align-items:center; gap:10px; margin-bottom:10px;
    }
    .material-symbols-rounded{ font-variation-settings:"FILL" 1, "GRAD" 200; }
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 100;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FFB300;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .security-notice { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px; margin-top: 16px; font-size: 13px; color: #856404; }
    .attempts-counter { font-size: 12px; margin-top: 8px; color: var(--warn); display: none; }
    .password-strength { height: 4px; margin-top: 8px; border-radius: 2px; transition: all 0.3s ease; }
    .strength-weak { background-color: #f44336; width: 33%; }
    .strength-medium { background-color: #ff9800; width: 66%; }
    .strength-strong { background-color: #4caf50; width: 100%; }
    .security-indicator { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 8px; color: #666; }
    .csrf-token { display: none; }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <p style="margin-top: 16px;">Memproses...</p>
  </div>

  <div class="glow"></div>

  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <div class="brand">
        <span class="material-symbols-rounded" style="color:#FF8F00;">workspace_premium</span>
        <h1 id="title">Presensi FUPA</h1>
      </div>
      <p class="sub">Masuk menggunakan email dan kata sandi. Jika mengalami kendala kata sandi, hubungi admin.</p>

      <div class="input" aria-hidden="false">
        <span class="material-symbols-rounded">mail</span>
        <input id="email" type="email" placeholder="Email kerja" autocomplete="username" aria-label="Email kerja" />
      </div>
      <div class="input">
        <span class="material-symbols-rounded">lock</span>
        <input id="password" type="password" placeholder="Kata sandi" autocomplete="current-password" aria-label="Kata sandi" />
        <button id="togglePass" class="btn" style="background:#eee;color:#222;box-shadow:none;padding:8px 10px;font-weight:600;" aria-label="Tampilkan kata sandi">
          <span class="material-symbols-rounded" id="eye">visibility</span>
        </button>
      </div>
      <div id="passwordStrength" class="password-strength" aria-hidden="true"></div>

      <div class="attempts-counter" id="attemptsCounter">
        Percobaan login: <span id="attemptsCount">0</span>/5. Akun akan terkunci setelah 5 percobaan gagal.
      </div>
      <div class="security-indicator" role="note" aria-live="polite">
        <span class="material-symbols-rounded" id="securityIcon">lock</span>
        <span id="securityText">Koneksi aman terenkripsi</span>
      </div>
      <div class="row">
        <span class="hint">Jika lupa sandi, hubungi admin.</span>
        <button id="loginBtn" class="btn" aria-label="Masuk"><span class="material-symbols-rounded">login</span> Masuk</button>
      </div>

      <div class="security-notice">
        <span class="material-symbols-rounded" style="font-size:16px; vertical-align:middle">shield</span>
        Sesi Anda akan berakhir setelah 12 jam tidak aktif atau setelah 24 jam penggunaan.
      </div>

      <!-- CSRF Token Field -->
      <input type="hidden" id="csrfToken" class="csrf-token" aria-hidden="true" />
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Firebase libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // CONFIG (user-provided keys)
    const firebaseConfig = {
      apiKey: "AIzaSyA08VBr5PfN5HB7_eub0aZ9-_FSFFHM62M",
      authDomain: "presence-system-adfd7.firebaseapp.com",
      projectId: "presence-system-adfd7",
      storageBucket: "presence-system-adfd7.firebasestorage.app",
      messagingSenderId: "84815583677",
      appId: "1:84815583677:web:12e743b9f5c2b0cb395ad4",
      measurementId: "G-HHJREDRFZB"
    };

    // Security/session params
    const SECURITY_CONFIG = {
      maxLoginAttempts: 5,
      lockoutDuration: 15 * 60 * 1000,    // 15 minutes
      sessionDuration: 12 * 60 * 60 * 1000, // 12 hours
      passwordMinLength: 8,
      tokenRefreshInterval: 30 * 60 * 1000 // 30 minutes (for session refresh attempts)
    };

    // State
    let loginAttempts = 0;
    let lockoutUntil = 0;
    let sessionTimer = null;
    let csrfToken = generateCSRFToken();

    // initialize firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // UI helpers
    const $ = (sel) => document.querySelector(sel);
    const toast = (msg, dur = 2200) => {
      const t = $("#toast");
      if (!t) return alert(msg);
      t.textContent = msg;
      t.style.display = "block";
      setTimeout(() => { t.style.display = "none"; }, dur);
    };

    // CSRF utilities
    function generateCSRFToken() {
      const array = new Uint8Array(16);
      window.crypto.getRandomValues(array);
      return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }
    function validateCSRFToken(token) { return token === csrfToken; }
    document.getElementById('csrfToken').value = csrfToken;

    // Password strength checker
    function checkPasswordStrength(password) {
      if (!password) return 0;
      let strength = 0;
      if (password.length >= SECURITY_CONFIG.passwordMinLength) strength += 1;
      if (password.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/)) strength += 1;
      if (password.match(/([0-9])/)) strength += 1;
      if (password.match(/([!,@,#,$,%,^,&,*,?,_,~])/)) strength += 1;
      return strength;
    }
    function updatePasswordStrengthIndicator(password) {
      const indicator = $('#passwordStrength');
      if (!indicator) return;
      const strength = checkPasswordStrength(password);
      indicator.className = 'password-strength';
      if (password.length > 0) {
        indicator.style.display = 'block';
        if (strength <= 2) indicator.classList.add('strength-weak');
        else if (strength === 3) indicator.classList.add('strength-medium');
        else indicator.classList.add('strength-strong');
      } else {
        indicator.style.display = 'none';
      }
    }
    $('#password').addEventListener('input', e => updatePasswordStrengthIndicator(e.target.value));

    // Toggle show password
    document.getElementById('togglePass').onclick = () => {
      const inp = document.getElementById('password');
      const eye = document.getElementById('eye');
      const is = inp.type === 'password';
      inp.type = is ? 'text' : 'password';
      eye.textContent = is ? 'visibility_off' : 'visibility';
    };

    // Lockout / attempts UI
    function updateAttemptsCounterUI() {
      const counter = $("#attemptsCounter");
      const count = $("#attemptsCount");
      if (loginAttempts > 0) { counter.style.display = "block"; count.textContent = loginAttempts; }
      else counter.style.display = "none";
    }

    // Persist lockout to localStorage (keeps state between reloads)
    const savedLockout = localStorage.getItem('lockoutUntil');
    if (savedLockout) {
      lockoutUntil = parseInt(savedLockout);
      if (Date.now() > lockoutUntil) { lockoutUntil = 0; localStorage.removeItem('lockoutUntil'); }
      else checkLockout();
    }
    setInterval(() => {
      if (lockoutUntil > 0) localStorage.setItem('lockoutUntil', lockoutUntil.toString());
      else localStorage.removeItem('lockoutUntil');
    }, 1000);

    function checkLockout() {
      if (Date.now() < lockoutUntil) {
        const mins = Math.ceil((lockoutUntil - Date.now()) / 60000);
        toast(`Terlalu banyak percobaan login. Coba lagi dalam ${mins} menit.`, 5000);
        return true;
      }
      return false;
    }

    // IP helper (best-effort)
    async function getClientIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const j = await res.json();
        return j.ip || 'unknown';
      } catch { return 'unknown'; }
    }

    // Security logs (create only)
    async function logSecurityEvent(type, data = {}) {
      try {
        const eventData = {
          type,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          userAgent: navigator.userAgent,
          ip: await getClientIP(),
          ...data
        };
        if (auth.currentUser) { eventData.uid = auth.currentUser.uid; eventData.email = auth.currentUser.email; }
        // create log (rules should allow authed users to create their own logs and admins to read)
        await db.collection("security_logs").add(eventData);
      } catch (err) {
        // don't block UX if logging fails
        console.warn("logSecurityEvent failed", err);
      }
    }

    // Session management (creates a session doc without storing sensitive tokens)
    async function createSessionRecord(user) {
      const expiresAt = firebase.firestore.Timestamp.fromDate(new Date(Date.now() + SECURITY_CONFIG.sessionDuration));
      const sessionData = {
        uid: user.uid,
        email: user.email || "",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        expiresAt,
        userAgent: navigator.userAgent,
        ip: await getClientIP(),
        valid: true
      };
      const ref = await db.collection("sessions").add(sessionData);
      localStorage.setItem('session_id', ref.id);
      return ref.id;
    }

    // Validate session (by stored session_id)
    async function checkSessionValidity() {
      const sessionId = localStorage.getItem('session_id');
      if (!sessionId) return false;
      try {
        const snap = await db.collection("sessions").doc(sessionId).get();
        if (!snap.exists) return false;
        const data = snap.data();
        if (!data.valid) return false;
        // expiresAt may be Firestore Timestamp
        const exp = data.expiresAt && data.expiresAt.toDate ? data.expiresAt.toDate() : new Date(data.expiresAt);
        if (exp < new Date()) {
          // session expired -> delete doc client-side (optional) and return false
          try { await db.collection("sessions").doc(sessionId).delete(); } catch {}
          localStorage.removeItem('session_id');
          return false;
        }
        // ownership check
        if (!auth.currentUser || auth.currentUser.uid !== data.uid) return false;
        return true;
      } catch (err) {
        console.error("checkSessionValidity error", err);
        return false;
      }
    }

    async function refreshSession() {
      const sessionId = localStorage.getItem('session_id');
      if (!sessionId) return;
      try {
        await db.collection("sessions").doc(sessionId).update({
          expiresAt: firebase.firestore.Timestamp.fromDate(new Date(Date.now() + SECURITY_CONFIG.sessionDuration))
        });
      } catch (err) {
        console.warn("refreshSession failed", err);
      }
    }

    // Bootstrap essential collections for a user (creates users doc if missing)
    async function bootstrapCollections(user) {
      const up = db.collection("users").doc(user.uid);
      const doc = await up.get();
      if (!doc.exists) {
        await up.set({
          email: user.email || "",
          role: "unknown",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        });
        await logSecurityEvent("user_created", { uid: user.uid });
      } else {
        await up.set({ lastLogin: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      }
    }

    // Role redirect helper (reads users/{uid}.role document)
    async function redirectByRole(user, adminPath = "admin.html", karyawanPath = "karyawan.html") {
      try {
        const snap = await db.collection("users").doc(user.uid).get();
        const data = snap.exists ? snap.data() : {};
        if (data.role === "admin") {
          location.href = adminPath;
        } else if (data.role === "karyawan") {
          location.href = karyawanPath;
        } else {
          // Role unknown: force sign-out and show message
          await auth.signOut();
          toast("Akun belum diaktifkan oleh admin. Hubungi admin.");
        }
      } catch (err) {
        console.error("redirectByRole error", err);
        toast("Gagal memeriksa peran. Coba lagi.");
        await auth.signOut();
      }
    }

    // Auth state listener
    auth.onAuthStateChanged(async (user) => {
      $("#loading").style.display = "none";
      const path = location.pathname.toLowerCase();
      if (!user) {
        // If visiting protected pages while not authed, redirect to index
        if (path.endsWith("karyawan.html") || path.endsWith("admin.html")) location.href = "index.html";
        // For login page, bind UI
        if (path.endsWith("index.html") || path.endsWith("/") ) bindLoginPage();
        return;
      }

      // User is signed in — validate session doc
      const ok = await checkSessionValidity();
      if (!ok) {
        await logSecurityEvent("invalid_session", { uid: user.uid });
        await auth.signOut();
        toast("Sesi tidak valid. Silakan login kembali.");
        return;
      }

      // ensure user documents exist
      await bootstrapCollections(user);
      await logSecurityEvent("user_login", { uid: user.uid });

      // start session refresh timer
      if (sessionTimer) clearInterval(sessionTimer);
      sessionTimer = setInterval(refreshSession, SECURITY_CONFIG.tokenRefreshInterval);

      // redirect to role page if currently on index
      if (path.endsWith("index.html") || path.endsWith("/")) {
        await redirectByRole(user);
      }
    });

    // LOGIN handler
    function bindLoginPage() {
      const loginBtn = $("#loginBtn");
      if (!loginBtn) return;

      loginBtn.onclick = async () => {
        if (checkLockout()) return;

        const email = $("#email").value.trim();
        const pass = $("#password").value;

        // CSRF check (prevent accidental submit reuse)
        const csrfInput = $("#csrfToken").value;
        if (!validateCSRFToken(csrfInput)) {
          toast("Token keamanan tidak valid. Silakan refresh halaman.");
          return;
        }

        if (!email || !pass) { toast("Isi email dan kata sandi."); return; }
        const emailRE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRE.test(email)) { toast("Format email tidak valid."); return; }
        if (pass.length < SECURITY_CONFIG.passwordMinLength) { toast(`Kata sandi harus minimal ${SECURITY_CONFIG.passwordMinLength} karakter.`); return; }

        $("#loading").style.display = "flex";
        loginBtn.disabled = true;

        try {
          await logSecurityEvent("login_attempt", { email });
          const cred = await auth.signInWithEmailAndPassword(email, pass);
          await logSecurityEvent("login_success", { email, uid: cred.user.uid });

          // reset attempts
          loginAttempts = 0; updateAttemptsCounterUI();

          // create session record (no token stored)
          await createSessionRecord(cred.user);

          // navigation will be handled by onAuthStateChanged
        } catch (e) {
          loginBtn.disabled = false;
          $("#loading").style.display = "none";

          await logSecurityEvent("login_failed", { email, error: e.code });

          loginAttempts++;
          updateAttemptsCounterUI();

          if (loginAttempts >= SECURITY_CONFIG.maxLoginAttempts) {
            lockoutUntil = Date.now() + SECURITY_CONFIG.lockoutDuration;
            localStorage.setItem('lockoutUntil', lockoutUntil.toString());
            await logSecurityEvent("account_lockout", { email, duration: SECURITY_CONFIG.lockoutDuration });
            toast(`Terlalu banyak percobaan login. Akun terkunci sementara selama 15 menit.`, 5000);
          }

          if (e.code === "auth/user-not-found") toast("Email tidak terdaftar.");
          else if (e.code === "auth/wrong-password") toast("Kata sandi salah.");
          else if (e.code === "auth/invalid-email") toast("Format email tidak valid.");
          else if (e.code === "auth/too-many-requests") toast("Terlalu banyak percobaan. Coba lagi nanti.");
          else toast("Gagal masuk. Periksa kembali kredensial.");
        }
      };
    }

    // PWA service worker registration
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(err => {
          console.warn("SW register failed", err);
        });
      });
    }

    // On-load minor UI init
    updateAttemptsCounterUI();
    $("#loading").style.display = "none";
  </script>
</body>
</html>